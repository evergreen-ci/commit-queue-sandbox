## this is a change
ignore:
  - "*.md" # dont schedule tests if a commit only changes markdown files
stepback: true

pre: &pre
  - command: git.get_project
    params:
      directory: src
  - func: create virtualenv

buildvariants:

  - display_name: Generate Tasks for Version
    name: generate-tasks-for-version
    run_on:
      - ubuntu1604-test
    tasks:
      - name: version_gen

  - display_name: TestBV1
    name: ubuntu1604
    run_on:
      - ubuntu1604-test
    tasks:
      - name: placeholder
        depends_on:
          - name: version_gen
            variant: generate-tasks-for-version
            omit_generated_tasks: true

  - name: release
    display_name: TestBV2
    run_on:
      - ubuntu1604-test
    tasks:
      - name: dependencyTask
      - name: placeholder

  - name: git-env-test
    display_name: TestBV3
    run_on:
      - ubuntu1604-test
    tasks:
      - name: placeholder
    depends_on:
      - name: version_gen
        variant: generate-tasks-for-version
      - name: dependencyTask
        variant: testBV4

  - name: testBV5
    display_name: TestBV5
    run_on:
      - ubuntu1604-test
    tasks:
      - name: placeholder
    depends_on:
      - name: dependencyTaskShouldActivate
        variant: testBV4

  - name: testBV6
    display_name: TestBV6
    run_on:
      - ubuntu1604-test
    tasks:
      - name: task_group1

  - name: testBV4
    display_name: TestBV4
    run_on:
      - ubuntu1604-test
    tasks:
      - name: dependencyTask
      - name: dependencyTaskShouldActivate
      - name: shouldNotActivate
      - name: depOfShouldNotActivate
      - name: shouldActivate

functions:
  create virtualenv:
    - command: shell.exec
      params:
        working_dir: src
        script: |
          echo "noop"
          git describe

parameters:
  - key: my_param
    value: hello world1!
    description: something to test parameters woot

post:
  - command: attach.xunit_results
    params:
      file: src/junit-*.xml

tasks:
  - name: placeholder
    depends_on:
        - name: version_gen
          variant: generate-tasks-for-version
    commands:
        - command: shell.exec
          params:
            working_dir: src
            script: |
              echo "noop2"

  - name: dependencyTask
    depends_on:
      - name: shouldNotActivate
    commands:
        - command: shell.exec
          params:
               script: |
                echo "noop2"

  - name: dependencyTaskShouldActivate
    depends_on:
      - name: shouldActivate
    commands:
        - command: shell.exec
          params:
               script: |
                echo "noop2"

  - name: dependencyTask3
    commands:
        - command: shell.exec
          params:
               script: |
                echo "noop2"

  - name: dependencyTask4
    commands:
        - command: shell.exec
          params:
               script: |
                 echo "noop2"

  - name: shouldNotActivate
    depends_on:
      - name: depOfShouldNotActivate
    commands:
        - command: shell.exec
          params:
            script: |
                echo "noop2"

  - name: shouldActivate
    commands:
        - command: shell.exec
          params:
            script: |
                echo "noop2"

  - name: depOfShouldNotActivate
    commands:
        - command: shell.exec
          params:
            script: |
                echo "noop2"

  - name: version_gen
    commands:
        - command: generate.tasks
          params:
            files:
              - src/evergreen.json

modules:
  - name: evergreen
    repo: git@github.com:evergreen-ci/evergreen.git
    prefix: ${workdir}/src
    branch: main

patch_aliases:
  - alias: "test2"
    variant: "^ubuntu1604$"
    task: "^test.*$"
    remote_path: ""

build_baron_settings:
  ticket_create_project: "EVG"
  ticket_search_projects: [ "EVG" ]


task_groups:
  - name: task_group1
    max_hosts: 1
    tasks:
      - dependencyTaskShouldActivate
      - dependencyTask3
      - dependencyTask4


#        depOfShouldNotActivate, dependencyTask does not get scheduled
# placeholder, depTask3 get scheduled