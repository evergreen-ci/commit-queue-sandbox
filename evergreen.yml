patch_aliases:
  - alias: "chaya-tag-from-yaml"
    variant_tags: ["commit-queue-variant"]
    task: ".*"

pre_error_fails_task: true
pre: &pre
  - command: git.get_project
    params:
      directory: src
  - func: create virtualenv

buildvariants:
  - name: bynns single task thing
    display_name: single task test
    modules:
      - ${pine_repo_name}
    run_on:
      - ubuntu2004-small
    tasks:
      - name: checkrun_test

  - name: attach-results-perf
    display_name: "Attach Results Performance Test"
    run_on: ubuntu2204-small
    expansions:
      num_tests: "500"
      failure_rate: "0.1"
      log_lines: "20"
    tasks:
      - attach-results-perf-test

  - name: gotest-perf
    display_name: "GoTest Parse Performance Test"
    run_on: ubuntu2204-small
    expansions:
      num_files: "10"
      tests_per_file: "100"
      failure_rate: "0.1"
    tasks:
      - gotest-perf-test

  - name: upload-traces-perf
    display_name: "Upload Traces Performance Test"
    run_on: ubuntu2204-small
    expansions:
      num_files: "74"
      spans_per_file: "5000"
    tasks:
      - upload-traces-perf-test

functions:
  create virtualenv:
    - command: shell.exec
      params:
        working_dir: src
        script: |
          echo "noop"
          git describe

post:
  - command: attach.results
    params:
      file_location: src/test_results.json
  - command: gotest.parse_files
    params:
      files:
        - "src/*.suite"

tasks:

  - name: checkrun_test
    commands:
      - command: shell.exec
        params:
          working_dir: src
          script: |
            echo "i am become checkrun"

  # Performance test for attach.results
  # Generates a large JSON file with many test results to test parallel log uploading.
  - name: attach-results-perf-test
    commands:
      - command: subprocess.exec
        params:
          binary: python3
          working_dir: src
          args:
            - "generate_results_file.py"
            - "${num_tests|500}"        # Number of test results
            - "${failure_rate|0.1}"     # Failure rate (0.0-1.0)
            - "${log_lines|20}"         # Log lines per test

  # Performance test for gotest.parse_files
  # Generates multiple .suite files with go test output to test parallel log uploading.
  - name: gotest-perf-test
    commands:
      - command: subprocess.exec
        params:
          binary: python3
          working_dir: src
          args:
            - "generate_gotest_files.py"
            - "${num_files|100}"          # Number of .suite files
            - "${tests_per_file|1000}"    # Tests per file
            - "${failure_rate|0.1}"      # Failure rate (0.0-1.0)

  # Performance test for upload-traces
  # Generates OTel trace files to test parallel trace uploading.
  - name: upload-traces-perf-test
    commands:
      - command: shell.exec
        params:
          script: |
            echo "OTel collector endpoint: '${otel_collector_endpoint}'"
      - command: subprocess.exec
        params:
          binary: python3
          working_dir: src
          args:
            - "generate_trace_files.py"
            - "${num_files|10}"          # Number of trace files
            - "${spans_per_file|100}"    # Spans per file

modules:
  - name: test-trigger
    repo: git@github.com:evergreen-ci/commit-queue-sandbox.git
    prefix: ${workdir}/src
    branch: test-trigger
    auto_update: true

build_baron_settings:
  ticket_create_project: "EVG"
  ticket_search_projects: ["EVG"]

github_checks_aliases:
  - variant: ".*"
    task: ".*"
